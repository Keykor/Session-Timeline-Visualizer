<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V1 Session Timeline Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #timelineSection h3 {
            margin-bottom: 15px;
            color: #333;
        }
        #timeline {
            margin: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
            overflow-y: hidden;
        }
        #timeline::-webkit-scrollbar {
            height: 12px;
        }
        #timeline::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        #timeline::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }
        #timeline::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .action-rect {
            cursor: pointer;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
        }
        .action-rect:hover {
            filter: drop-shadow(3px 3px 6px rgba(0,0,0,0.3));
            transform: translateY(-1px);
        }
        .page-transition-line {
            stroke: #e74c3c;
            stroke-width: 3;
            stroke-dasharray: 5,5;
            opacity: 0.8;
            cursor: pointer;
        }
        .page-transition-line:hover {
            stroke-width: 4;
            opacity: 1;
            stroke-dasharray: none;
        }
        .page-label {
            font-size: 12px;
            fill: #e74c3c;
            font-weight: bold;
            text-anchor: middle;
            font-family: Arial, sans-serif;
        }
        .timeline-axis {
            font-size: 12px;
            fill: #555;
            font-family: Arial, sans-serif;
        }
        .timeline-axis path,
        .timeline-axis line {
            stroke: #999;
        }
        .action-text {
            font-family: Arial, sans-serif;
            font-size: 11px;
            font-weight: 500;
            pointer-events: none;
        }
        .custom-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            max-width: 300px;
            line-height: 1.4;
        }
        .custom-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        .legend-box {
            position: relative;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .legend-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        .legend-header:hover {
            background: #e9ecef;
        }
        .legend-toggle {
            font-size: 18px;
            color: #666;
            transition: transform 0.3s ease;
        }
        .legend-toggle.collapsed {
            transform: rotate(180deg);
        }
        .legend-content {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .legend-content.collapsed {
            display: none;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            background: #f9f9f9;
            font-size: 13px;
        }
        .legend-color {
            width: 20px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        .header-section {
            margin-bottom: 20px;
        }
        .title-and-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .title-with-switch {
            display: flex;
            align-items: center;
            gap: 25px;
            flex-wrap: wrap;
        }
        .file-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .file-selector label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
            margin-right: 8px;
        }
        .file-selector input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .file-selector button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .file-selector button:hover {
            background: #0056b3;
        }
        .mode-switch {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #007bff;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #28a745;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .mode-labels {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 14px;
        }
        .mode-labels .v1 {
            color: #007bff;
        }
        .mode-labels .v2 {
            color: #28a745;
        }
        .session-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .session-info h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        .actions-table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .actions-table th, .actions-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .actions-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .actions-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .action-color-indicator {
            width: 20px;
            height: 16px;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.2);
            display: inline-block;
            margin-right: 8px;
        }
        .error-message {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <div class="title-and-selector">
                <div class="title-with-switch">
                    <h1>V1 Session Timeline Visualizer</h1>
                    <div class="mode-switch">
                        <div class="mode-labels">
                            <span class="v1">V1</span>
                            <label class="switch">
                                <input type="checkbox" id="modeSwitch">
                                <span class="slider"></span>
                            </label>
                            <span class="v2">V2</span>
                        </div>
                    </div>
                </div>
                <div class="file-selector">
                    <label for="fileInput">Load Session:</label>
                    <input type="file" id="fileInput" accept=".json" />
                </div>
            </div>
        </div>

        <div id="sessionInfo" class="session-info" style="display: none;">
            <h3>Session Information</h3>
            <div id="sessionDetails"></div>
        </div>

        <div id="timelineSection" style="display: none;">
            <h3>Timeline</h3>
            <div id="timeline"></div>
        </div>

        <div id="legendBox" class="legend-box" style="display: none;">
            <div class="legend-header" onclick="toggleLegend()">
                <span>Action Legend</span>
                <span class="legend-toggle collapsed">▼</span>
            </div>
            <div id="legendContent" class="legend-content collapsed">
                <!-- Dynamically filled -->
            </div>
        </div>

        <div id="actionsTable" style="display: none;">
            <h3>Action Details (times relative to session start)</h3>
            <table class="actions-table">
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Page</th>
                        <th>Start (s)</th>
                        <th>End (s)</th>
                        <th>Duration (s)</th>
                    </tr>
                </thead>
                <tbody id="actionsTableBody">
                </tbody>
            </table>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <script>
        // ===========================================
        // V1 CONFIGURATION (Original flow)
        // ===========================================
        const V1_ACTION_COLORS = {
            'View six movies and select one': '#FF6B6B',
            'Click next to radius theater map': '#4ECDC4',
            'View four distance filters and select one': '#45B7D1',
            'View six movie theaters and select one': '#96CEB4',
            'Click back to movies': '#FFEAA7',
            'Click next to date': '#DDA0DD',
            'View six dates and select one': '#98D8C8',
            'Click back to theater': '#F7DC6F',
            'Click next to show': '#BB8FCE',
            'View four times and select one': '#85C1E9',
            'Click back to date': '#F8C471',
            'Click next to seat selection': '#82E0AA',
            'View and decide to select a seat': '#F1948A',
            'Click back to show': '#D7BDE2',
            'Click next to summary': '#A9DFBF',
            'View summary and decide to buy': '#F9E79F'
        };

        const V1_ACTION_CONFIG = {
            'View six movies and select one': { page: '/v1', start: 'page_load_time', end: 'last_movie_click' },
            'Click next to radius theater map': { page: '/v1', start: 'last_movie_click', end: 'next_click' },
            'View four distance filters and select one': { page: '/theatre', start: 'page_load_time', end: 'last_distance_click' },
            'View six movie theaters and select one': { page: '/theatre', start: 'last_distance_click', end: 'last_theatre_click' },
            'Click back to movies': { page: '/theatre', start: 'page_load_time', end: 'back_click' },
            'Click next to date': { page: '/theatre', start: 'last_theatre_click', end: 'next_click' },
            'View six dates and select one': { page: '/date', start: 'page_load_time', end: 'last_date_click' },
            'Click back to theater': { page: '/date', start: 'page_load_time', end: 'back_click' },
            'Click next to show': { page: '/date', start: 'last_date_click', end: 'next_click' },
            'View four times and select one': { page: '/show', start: 'page_load_time', end: 'last_show_click' },
            'Click back to date': { page: '/show', start: 'page_load_time', end: 'back_click' },
            'Click next to seat selection': { page: '/show', start: 'last_show_click', end: 'next_click' },
            'View and decide to select a seat': { page: '/seat', start: 'page_load_time', end: 'last_seat_click' },
            'Click back to show': { page: '/seat', start: 'page_load_time', end: 'back_click' },
            'Click next to summary': { page: '/seat', start: 'last_seat_click', end: 'next_click' },
            'View summary and decide to buy': { page: '/summary', start: 'page_load_time', end: 'visit_end_time' }
        };

        // ===========================================
        // V2 CONFIGURATION (Simplified flow)
        // ===========================================
        const V2_ACTION_COLORS = {
            'View six movies and select one ': '#8B5CF6',
            'Click next to date page': '#10B981',
            'View six options and select one': '#F59E0B',
            'Click next to summary': '#EF4444',
            'View summary and decide to buy': '#6366F1',
            // Special /options page actions
            'View six dates and select one': '#FF6B6B',
            'View four time slots and select one': '#4ECDC4',
            'View four radius and do not select one': '#45B7D1',
            'View nine seat areas and select one': '#96CEB4',
            'Click next to options': '#FCEA2B'
        };

        const V2_ACTION_CONFIG = {
            'View six movies and select one ': { page: '/v2', start: 'page_load_time', end: 'last_movie_click' },
            'Click next to date page': { page: '/v2', start: 'last_movie_click', end: 'next_click' },
            'View six options and select one': { page: '/filtered_options', start: 'page_load_time', end: 'last_option_click' },
            'Click next to summary': { page: '/filtered_options', start: 'last_option_click', end: 'next_click' },
            'View summary and decide to buy': { page: '/summary', start: 'page_load_time', end: 'visit_end_time' }
        };

        // ===========================================
        // HELPER FUNCTIONS
        // ===========================================
        function getCurrentActionColors() {
            const isV2Mode = document.getElementById('modeSwitch').checked;
            return isV2Mode ? V2_ACTION_COLORS : V1_ACTION_COLORS;
        }

        function getCurrentActionConfig() {
            const isV2Mode = document.getElementById('modeSwitch').checked;
            return isV2Mode ? V2_ACTION_CONFIG : V1_ACTION_CONFIG;
        }

        function parseTime(timestamp) {
            if (typeof timestamp === 'string') {
                return new Date(timestamp).getTime();
            }
            return new Date(timestamp).getTime();
        }

        // ===========================================
        // V1 PROCESSING FUNCTION
        // ===========================================
        function calculateV1ActionTimes(sessionData) {
            const actions = [];
            const pageTransitions = [];
            let sessionStart = Infinity;
            let sessionEnd = 0;

            const hasV1Page = sessionData.pages.some(page => page.page.startsWith('/v1'));
            if (!hasV1Page) {
                throw new Error('This session does not contain /v1 pages.');
            }

            for (const page of sessionData.pages) {
                const state = {};
                state.current_page = page.page.split('?')[0];
                state.page_load_time = parseTime(page.visitStartTime) + page.pageTransitionDuration;
                state.visit_end_time = parseTime(page.visitEndTime);

                sessionStart = Math.min(sessionStart, state.page_load_time);
                sessionEnd = Math.max(sessionEnd, state.visit_end_time);

                pageTransitions.push({
                    page: state.current_page,
                    time: state.page_load_time
                });

                // V1 specific click parsing
                for (const click of page.clicks.sort((a, b) => a.time - b.time)) {
                    const clickTime = parseTime(click.time);
                    const trackId = click.trackId ? click.trackId.toLowerCase() : null;

                    if (click.element === 'LI') {
                        state.last_distance_click = clickTime;
                        continue;
                    }

                    if (!trackId) continue;

                    const [thing, value] = trackId.split('=');
                    const cleanValue = value.replace(/"/g, '');

                    if (thing === 'button') {
                        if (cleanValue === 'next') {
                            state.next_click = clickTime;
                        } else if (cleanValue === 'back') {
                            state.back_click = clickTime;
                        }
                    } else if (thing === 'movie-card') {
                        state.last_movie_click = clickTime;
                    } else if (thing === 'schedule') {
                        state.last_date_click = clickTime;
                    } else if (thing === 'theatre-card') {
                        state.last_theatre_click = clickTime;
                    } else if (thing === 'show-time') {
                        state.last_show_click = clickTime;
                    } else if (thing === 'seat') {
                        state.last_seat_click = clickTime;
                    }
                }

                if (!state.last_distance_click) {
                    state.last_distance_click = state.page_load_time;
                }

                // Process V1 actions
                for (const [actionName, config] of Object.entries(V1_ACTION_CONFIG)) {
                    if (config.page !== state.current_page) continue;

                    const startTime = state[config.start];
                    const endTime = state[config.end];

                    if (!startTime || !endTime || endTime <= startTime) continue;

                    actions.push({
                        name: actionName,
                        startTime: startTime,
                        endTime: endTime,
                        duration: endTime - startTime,
                        page: config.page
                    });
                }
            }

            return {
                actions: actions.sort((a, b) => a.startTime - b.startTime),
                pageTransitions: pageTransitions.sort((a, b) => a.time - b.time),
                sessionStart,
                sessionEnd,
                sessionDuration: sessionEnd - sessionStart
            };
        }

        // ===========================================
        // V2 SPECIAL CASE HANDLER FOR /options PAGE
        // ===========================================
        function handleV2OptionsPage(page) {
            if (page.page.split('?')[0] !== '/options') {
                return [];
            }

            const actions = [];
            const state = {};
            state.current_page = page.page.split('?')[0];
            state.page_load_time = parseTime(page.visitStartTime) + page.pageTransitionDuration;
            state.visit_end_time = parseTime(page.visitEndTime);

            const clicks = page.clicks.filter(click => click.trackId).sort((a, b) => a.time - b.time);

            if (clicks.length > 0) {
                let previousClickTime = state.page_load_time;

                clicks.forEach(click => {
                    const trackId = click.trackId.toLowerCase();
                    const clickTime = parseTime(click.time);

                    if (trackId.includes('date')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'View six dates and select one',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    } else if (trackId.includes('timespan')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'View four time slots and select one',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    } else if (trackId.includes('distance')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'View four radius and do not select one',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    } else if (trackId.includes('seat-area')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'View nine seat areas and select one',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    } else if (trackId.includes('button="next"')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'Click next to options',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    }

                    previousClickTime = clickTime;
                });
            }

            return actions;
        }

        // ===========================================
        // V2 PROCESSING FUNCTION
        // ===========================================
        function calculateV2ActionTimes(sessionData) {
            const actions = [];
            const pageTransitions = [];
            let sessionStart = Infinity;
            let sessionEnd = 0;

            const hasV2Page = sessionData.pages.some(page => page.page.startsWith('/v2'));
            if (!hasV2Page) {
                throw new Error('This session does not contain /v2 pages.');
            }

            for (const page of sessionData.pages) {
                const state = {};
                state.current_page = page.page.split('?')[0];
                state.page_load_time = parseTime(page.visitStartTime) + page.pageTransitionDuration;
                state.visit_end_time = parseTime(page.visitEndTime);

                sessionStart = Math.min(sessionStart, state.page_load_time);
                sessionEnd = Math.max(sessionEnd, state.visit_end_time);

                pageTransitions.push({
                    page: state.current_page,
                    time: state.page_load_time
                });

                // Check for special case handling for /options page
                const specialCaseActions = handleV2OptionsPage(page);
                if (specialCaseActions.length > 0) {
                    actions.push(...specialCaseActions);
                    continue;
                }

                // Normal V2 processing for other pages
                // V2 specific click parsing - follows the original V2 logic
                for (const click of page.clicks.sort((a, b) => a.time - b.time)) {
                    const clickTime = parseTime(click.time);
                    const trackId = click.trackId ? click.trackId.toLowerCase() : null;

                    if (!trackId) continue;

                    // V2 uses both patterns: thing=value AND includes
                    const [thing, value] = trackId.split('=');
                    const cleanValue = value ? value.replace(/"/g, '') : '';

                    if (thing === 'button') {
                        if (cleanValue === 'next') {
                            state.next_click = clickTime;
                        } else if (cleanValue === 'back') {
                            state.back_click = clickTime;
                        }
                    } else if (thing === 'movie-card') {
                        state.last_movie_click = clickTime;
                    } else if (thing === 'selected-option') {
                        state.last_option_click = clickTime;
                    }
                }

                // Process V2 actions
                for (const [actionName, config] of Object.entries(V2_ACTION_CONFIG)) {
                    if (config.page !== state.current_page) continue;

                    const startTime = state[config.start];
                    const endTime = state[config.end];

                    if (!startTime || !endTime || endTime <= startTime) continue;

                    actions.push({
                        name: actionName,
                        startTime: startTime,
                        endTime: endTime,
                        duration: endTime - startTime,
                        page: config.page
                    });
                }
            }

            return {
                actions: actions.sort((a, b) => a.startTime - b.startTime),
                pageTransitions: pageTransitions.sort((a, b) => a.time - b.time),
                sessionStart,
                sessionEnd,
                sessionDuration: sessionEnd - sessionStart
            };
        }

        // ===========================================
        // MAIN PROCESSING FUNCTION (Router)
        // ===========================================
        function calculateActionTimesForVisualization(sessionData) {
            const isV2Mode = document.getElementById('modeSwitch').checked;
            return isV2Mode ? calculateV2ActionTimes(sessionData) : calculateV1ActionTimes(sessionData);
        }

        function detectSessionType(sessionData) {
            const hasV1Page = sessionData.pages.some(page => page.page.startsWith('/v1'));
            const hasV2Page = sessionData.pages.some(page => page.page.startsWith('/v2'));

            if (hasV2Page && !hasV1Page) {
                return 'v2';
            } else if (hasV1Page && !hasV2Page) {
                return 'v1';
            } else if (hasV1Page && hasV2Page) {
                // If both exist, prefer the one with more pages
                const v1Pages = sessionData.pages.filter(page => page.page.startsWith('/v1')).length;
                const v2Pages = sessionData.pages.filter(page => page.page.startsWith('/v2')).length;
                return v2Pages > v1Pages ? 'v2' : 'v1';
            }

            return null; // Neither found
        }

        function visualizeSession(sessionData) {
            try {
                // Auto-detect session type and adjust switch
                const detectedType = detectSessionType(sessionData);
                const modeSwitch = document.getElementById('modeSwitch');

                if (detectedType === 'v2' && !modeSwitch.checked) {
                    isAutoAdjusting = true;
                    modeSwitch.checked = true;
                    updateTitle();
                    isAutoAdjusting = false;
                } else if (detectedType === 'v1' && modeSwitch.checked) {
                    isAutoAdjusting = true;
                    modeSwitch.checked = false;
                    updateTitle();
                    isAutoAdjusting = false;
                }

                const result = calculateActionTimesForVisualization(sessionData);
                const { actions, pageTransitions, sessionStart, sessionEnd, sessionDuration } = result;

                document.getElementById('sessionInfo').style.display = 'block';
                document.getElementById('timelineSection').style.display = 'block';
                document.getElementById('legendBox').style.display = 'block';
                document.getElementById('actionsTable').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';

                // Mostrar información de la sesión
                const sessionDetails = document.getElementById('sessionDetails');
                const durationSeconds = (sessionDuration / 1000).toFixed(2);
                sessionDetails.innerHTML = `
                    <p><strong>UUID:</strong> ${sessionData.uuid || 'N/A'}</p>
                    <p><strong>Version:</strong> ${sessionData.version || 'N/A'}</p>
                    <p><strong>Total duration:</strong> ${durationSeconds} seconds</p>
                    <p><strong>Actions found:</strong> ${actions.length}</p>
                `;

                // Crear timeline con D3.js
                createD3Timeline(actions, sessionStart, sessionEnd, sessionDuration);
                createLegend(actions);
                createActionsTable(actions, sessionStart);

            } catch (error) {
                showError(error.message);
            }
        }

        function createD3Timeline(actions, sessionStart, sessionEnd, sessionDuration) {
            // Limpiar timeline anterior y tooltips existentes
            d3.select('#timeline').selectAll('*').remove();
            d3.selectAll('.custom-tooltip').remove();

            // Calcular ancho mínimo basado en duración de sesión
            const minPixelsPerSecond = 20; // píxeles por segundo mínimo para buena legibilidad
            const sessionDurationSeconds = sessionDuration / 1000;
            const minRequiredWidth = sessionDurationSeconds * minPixelsPerSecond;

            const containerMaxWidth = window.innerWidth - 100;
            const margin = { top: 80, right: 50, bottom: 80, left: 50 };

            // Usar el mayor entre el ancho mínimo requerido y el ancho disponible
            const totalWidth = Math.max(minRequiredWidth + margin.left + margin.right, containerMaxWidth);
            const width = totalWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select('#timeline')
                .append('svg')
                .attr('width', totalWidth)
                .attr('height', height + margin.top + margin.bottom)
                .style('background', '#fafafa')
                .style('border-radius', '8px')
                .style('min-width', totalWidth + 'px');

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Crear tooltip personalizado
            const tooltip = d3.select('body').append('div')
                .attr('class', 'custom-tooltip')
                .style('opacity', 0);

            // Escala de tiempo
            const xScale = d3.scaleLinear()
                .domain([0, sessionDuration / 1000])
                .range([0, width]);

            // Eje X
            const xAxis = d3.axisBottom(xScale)
                .tickFormat(d => `${d}s`)
                .ticks(Math.min(10, Math.floor(sessionDuration / 5000)));

            g.append('g')
                .attr('transform', `translate(0,${height - 10})`)
                .call(xAxis)
                .selectAll('text')
                .attr('class', 'timeline-axis');

            // Grilla de fondo
            const xGrid = d3.axisBottom(xScale)
                .tickSize(-height + 20)
                .tickFormat('')
                .ticks(Math.min(10, Math.floor(sessionDuration / 5000)));

            g.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(0,${height - 10})`)
                .call(xGrid)
                .selectAll('line')
                .style('stroke', '#e0e0e0')
                .style('stroke-width', 1);

            // Crear secuencia de visitas por continuidad temporal, no solo por ID de página
            const pageVisits = [];
            let currentPage = null;
            let currentVisit = null;

            // Ordenar acciones por tiempo
            const sortedActions = [...actions].sort((a, b) => a.startTime - b.startTime);

            sortedActions.forEach(action => {
                if (action.page !== currentPage) {
                    // Nueva visita a una página
                    if (currentVisit) {
                        pageVisits.push(currentVisit);
                    }
                    currentPage = action.page;
                    currentVisit = {
                        page: action.page,
                        startTime: action.startTime,
                        endTime: action.endTime,
                        actions: [action]
                    };
                } else {
                    // Continúa en la misma página
                    currentVisit.endTime = Math.max(currentVisit.endTime, action.endTime);
                    currentVisit.actions.push(action);
                }
            });

            if (currentVisit) {
                pageVisits.push(currentVisit);
            }

            // Líneas de transición entre visitas (movibles)
            pageVisits.forEach((visit, visitIndex) => {
                if (visitIndex > 0) {
                    const relativeStart = (visit.startTime - sessionStart) / 1000;

                    const transitionGroup = g.append('g')
                        .attr('class', 'page-transition-group');

                    const line = transitionGroup.append('line')
                        .attr('class', 'page-transition-line')
                        .attr('x1', xScale(relativeStart))
                        .attr('x2', xScale(relativeStart))
                        .attr('y1', 20)
                        .attr('y2', height - 40)
                        .on('mouseover', function(event) {
                            const visitDuration = ((visit.endTime - visit.startTime) / 1000).toFixed(2);
                            const actionsInVisit = visit.actions.length;
                            const actionsList = visit.actions.map(a => `• ${a.name}`).join('\n');

                            const tooltipContent = `
                                <div style="font-weight: bold; margin-bottom: 8px; color: #e74c3c;">📄 ${visit.page}</div>
                                <div style="margin-bottom: 5px;"><strong>Start:</strong> ${relativeStart.toFixed(2)}s</div>
                                <div style="margin-bottom: 5px;"><strong>Duration:</strong> ${visitDuration}s</div>
                                <div style="margin-bottom: 8px;"><strong>Actions:</strong> ${actionsInVisit}</div>
                                <div style="font-size: 11px; color: #ccc; border-top: 1px solid #444; padding-top: 8px;">
                                    ${actionsList}
                                </div>
                            `;

                            tooltip.transition()
                                .duration(200)
                                .style('opacity', 1);

                            tooltip.html(tooltipContent)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mousemove', function(event) {
                            tooltip
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mouseout', function() {
                            tooltip.transition()
                                .duration(200)
                                .style('opacity', 0);
                        });

                    transitionGroup.append('rect')
                        .attr('class', 'page-label-bg')
                        .attr('x', xScale(relativeStart) - 25)
                        .attr('y', 0)
                        .attr('width', 50)
                        .attr('height', 18)
                        .attr('fill', 'white')
                        .attr('stroke', '#e74c3c')
                        .attr('stroke-width', 1)
                        .attr('rx', 4)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event) {
                            const visitDuration = ((visit.endTime - visit.startTime) / 1000).toFixed(2);
                            const actionsInVisit = visit.actions.length;
                            const actionsList = visit.actions.map(a => `• ${a.name}`).join('\n');

                            const tooltipContent = `
                                <div style="font-weight: bold; margin-bottom: 8px; color: #e74c3c;">📄 ${visit.page}</div>
                                <div style="margin-bottom: 5px;"><strong>Start:</strong> ${relativeStart.toFixed(2)}s</div>
                                <div style="margin-bottom: 5px;"><strong>Duration:</strong> ${visitDuration}s</div>
                                <div style="margin-bottom: 8px;"><strong>Actions:</strong> ${actionsInVisit}</div>
                                <div style="font-size: 11px; color: #ccc; border-top: 1px solid #444; padding-top: 8px;">
                                    ${actionsList}
                                </div>
                            `;

                            tooltip.transition()
                                .duration(200)
                                .style('opacity', 1);

                            tooltip.html(tooltipContent)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mousemove', function(event) {
                            tooltip
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mouseout', function() {
                            tooltip.transition()
                                .duration(200)
                                .style('opacity', 0);
                        });

                    transitionGroup.append('text')
                        .attr('class', 'page-label')
                        .attr('x', xScale(relativeStart))
                        .attr('y', 12)
                        .text(visit.page)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event) {
                            const visitDuration = ((visit.endTime - visit.startTime) / 1000).toFixed(2);
                            const actionsInVisit = visit.actions.length;
                            const actionsList = visit.actions.map(a => `• ${a.name}`).join('\n');

                            const tooltipContent = `
                                <div style="font-weight: bold; margin-bottom: 8px; color: #e74c3c;">📄 ${visit.page}</div>
                                <div style="margin-bottom: 5px;"><strong>Start:</strong> ${relativeStart.toFixed(2)}s</div>
                                <div style="margin-bottom: 5px;"><strong>Duration:</strong> ${visitDuration}s</div>
                                <div style="margin-bottom: 8px;"><strong>Actions:</strong> ${actionsInVisit}</div>
                                <div style="font-size: 11px; color: #ccc; border-top: 1px solid #444; padding-top: 8px;">
                                    ${actionsList}
                                </div>
                            `;

                            tooltip.transition()
                                .duration(200)
                                .style('opacity', 1);

                            tooltip.html(tooltipContent)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mousemove', function(event) {
                            tooltip
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mouseout', function() {
                            tooltip.transition()
                                .duration(200)
                                .style('opacity', 0);
                        });
                }
            });

            // Organizar acciones en una sola línea temporal sin carriles de páginas
            const actionHeight = 30;
            const timelineY = height / 2 - actionHeight / 2;

            actions.forEach((action, index) => {
                const relativeStart = (action.startTime - sessionStart) / 1000;
                const duration = action.duration / 1000;

                // Calcular offset vertical para evitar superposiciones
                const overlapOffset = (index % 3) * 35 - 35; // -35, 0, 35
                const y = timelineY + overlapOffset;

                const actionGroup = g.append('g')
                    .attr('class', 'action-group');

                // Sombra del rectángulo
                actionGroup.append('rect')
                    .attr('x', xScale(relativeStart) + 2)
                    .attr('y', y + 2)
                    .attr('width', Math.max(xScale(duration), 30))
                    .attr('height', actionHeight)
                    .attr('fill', 'rgba(0,0,0,0.15)')
                    .attr('rx', 6);

                // Rectángulo principal
                actionGroup.append('rect')
                    .attr('class', 'action-rect')
                    .attr('x', xScale(relativeStart))
                    .attr('y', y)
                    .attr('width', Math.max(xScale(duration), 30))
                    .attr('height', actionHeight)
                    .attr('fill', getCurrentActionColors()[action.name] || '#999')
                    .attr('stroke', 'white')
                    .attr('stroke-width', 2)
                    .attr('rx', 6)
                    .on('mouseover', function(event) {
                        const tooltipContent = `
                            <div style="font-weight: bold; margin-bottom: 5px;">${action.name}</div>
                            <div>Start: ${relativeStart.toFixed(2)}s</div>
                            <div>End: ${(relativeStart + duration).toFixed(2)}s</div>
                            <div>Duration: ${duration.toFixed(2)}s</div>
                            <div style="margin-top: 5px; color: #ccc;">Page: ${action.page}</div>
                        `;

                        tooltip.transition()
                            .duration(200)
                            .style('opacity', 1);

                        tooltip.html(tooltipContent)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mousemove', function(event) {
                        tooltip
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        tooltip.transition()
                            .duration(200)
                            .style('opacity', 0);
                    });

                // Texto de la acción
                const textWidth = Math.max(xScale(duration), 30);
                const maxChars = Math.floor(textWidth / 7);
                const text = action.name.length > maxChars ? action.name.substring(0, maxChars - 3) + '...' : action.name;

                actionGroup.append('text')
                    .attr('class', 'action-text')
                    .attr('x', xScale(relativeStart) + textWidth / 2)
                    .attr('y', y + actionHeight / 2 + 4)
                    .attr('text-anchor', 'middle')
                    .attr('fill', 'white')
                    .style('text-shadow', '1px 1px 2px rgba(0,0,0,0.8)')
                    .text(text);

                // No necesitamos más el tooltip SVG ya que usamos uno personalizado
            });
        }

        function createLegend(actions) {
            const legendContent = document.getElementById('legendContent');
            legendContent.innerHTML = '';

            // Obtener acciones únicas
            const uniqueActions = [...new Set(actions.map(action => action.name))];

            uniqueActions.forEach(actionName => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = getCurrentActionColors()[actionName] || '#999';

                const label = document.createElement('span');
                label.textContent = actionName;

                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                legendContent.appendChild(legendItem);
            });
        }

        function toggleLegend() {
            const content = document.getElementById('legendContent');
            const toggle = document.querySelector('.legend-toggle');

            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        function createActionsTable(actions, sessionStart) {
            const tableBody = document.getElementById('actionsTableBody');
            tableBody.innerHTML = '';

            actions.forEach(action => {
                const row = document.createElement('tr');

                const relativeStart = ((action.startTime - sessionStart) / 1000).toFixed(2);
                const relativeEnd = ((action.endTime - sessionStart) / 1000).toFixed(2);
                const duration = (action.duration / 1000).toFixed(2);

                row.innerHTML = `
                    <td>
                        <span class="action-color-indicator" style="background-color: ${getCurrentActionColors()[action.name] || '#999'}"></span>
                        ${action.name}
                    </td>
                    <td>${action.page}</td>
                    <td>${relativeStart}</td>
                    <td>${relativeEnd}</td>
                    <td>${duration}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('sessionInfo').style.display = 'none';
            document.getElementById('timelineSection').style.display = 'none';
            document.getElementById('legendBox').style.display = 'none';
            document.getElementById('actionsTable').style.display = 'none';
        }

        // Update title based on mode
        function updateTitle() {
            const isV2Mode = document.getElementById('modeSwitch').checked;
            const titleElement = document.querySelector('h1');
            titleElement.textContent = isV2Mode ? 'V2 Session Timeline Visualizer' : 'V1 Session Timeline Visualizer';
        }

        // Flag to prevent infinite loops during auto-detection
        let isAutoAdjusting = false;

        // Mode switch event listener
        document.getElementById('modeSwitch').addEventListener('change', function() {
            updateTitle();

            // Only re-process if this is a user-initiated change, not auto-adjustment
            if (!isAutoAdjusting) {
                // Re-process current file if there's one loaded (works for both V1→V2 and V2→V1)
                const fileInput = document.getElementById('fileInput');
                if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const sessionData = JSON.parse(e.target.result);
                            visualizeSession(sessionData);
                        } catch (error) {
                            showError('Error parsing JSON file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            }
        });

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const sessionData = JSON.parse(e.target.result);
                    visualizeSession(sessionData);
                } catch (error) {
                    showError('Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>