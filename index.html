<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V1 Session Timeline Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #timelineSection h3 {
            margin-bottom: 15px;
            color: #333;
        }
        #timeline {
            margin: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
            overflow-y: hidden;
        }
        #timeline::-webkit-scrollbar {
            height: 12px;
        }
        #timeline::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        #timeline::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }
        #timeline::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .action-rect {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .action-rect:hover {
            opacity: 0.8;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            word-wrap: break-word;
        }
        .page-transition {
            stroke: #ff6b6b;
            stroke-width: 2;
            opacity: 0.7;
            pointer-events: none;
        }
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .legend h4 {
            margin: 0 0 10px 0;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-toggle {
            font-size: 12px;
            color: #666;
        }
        .legend-content {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }
        .legend-content.open {
            display: grid;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 20px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        .legend-text {
            font-size: 12px;
            color: #555;
        }
        .file-input-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            text-align: center;
        }
        .file-input-container:hover {
            border-color: #adb5bd;
            background: #e9ecef;
        }
        .file-input {
            margin: 10px 0;
        }
        .file-input input[type="file"] {
            padding: 8px 16px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .file-input input[type="file"]:hover {
            border-color: #adb5bd;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header h1 {
            margin: 0;
            color: #333;
            flex: 1;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .mode-label {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        .error-message {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Session Timeline Visualizer</h1>
            <div class="header-controls">
                <div class="file-input">
                    <input type="file" id="fileInput" accept=".json" />
                </div>
                <div class="mode-label">V1</div>
                <label class="switch">
                    <input type="checkbox" id="modeSwitch">
                    <span class="slider"></span>
                </label>
                <div class="mode-label">V2</div>
            </div>
        </div>

        <div id="errorContainer"></div>

        <div id="timelineSection" style="display: none;">
            <h3 id="timelineTitle">Session Timeline</h3>
            <div id="timeline"></div>
            <div class="legend">
                <h4 onclick="toggleLegend()">
                    Legend
                    <span class="legend-toggle" id="legendToggle">[+]</span>
                </h4>
                <div class="legend-content" id="legendContent">
                    <!-- Legend items will be dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // GLOBAL VARIABLES
        // ===========================================
        let currentSessionData = null;
        let tooltip;

        // ===========================================
        // V1 CONFIGURATION (Original multi-step flow)
        // ===========================================
        const V1_ACTION_COLORS = {
            'View six movies and select one': '#FF6B6B',
            'Click next to radius theater map': '#4ECDC4',
            'View four distance filters and select one': '#45B7D1',
            'View six movie theaters and select one': '#96CEB4',
            'Click back to movies': '#FECA57',
            'Click next to date': '#FF9FF3',
            'View six dates and select one': '#54A0FF',
            'Click back to theater': '#5F27CD',
            'Click next to show': '#00D2D3',
            'View four times and select one': '#85C1E9',
            'Click back to date': '#F8C471',
            'Click next to seat selection': '#82E0AA',
            'View and decide to select a seat': '#F1948A',
            'Click back to show': '#D7BDE2',
            'Click next to summary': '#A9DFBF',
            'View summary and decide to buy': '#F9E79F'
        };

        const V1_ACTION_CONFIG = {
            'View six movies and select one': { page: '/v1', start: 'page_load_time', end: 'last_movie_click' },
            'Click next to radius theater map': { page: '/v1', start: 'last_movie_click', end: 'next_click' },
            'View four distance filters and select one': { page: '/theatre', start: 'page_load_time', end: 'last_distance_click' },
            'View six movie theaters and select one': { page: '/theatre', start: 'last_distance_click', end: 'last_theatre_click' },
            'Click back to movies': { page: '/theatre', start: 'page_load_time', end: 'back_click' },
            'Click next to date': { page: '/theatre', start: 'last_theatre_click', end: 'next_click' },
            'View six dates and select one': { page: '/date', start: 'page_load_time', end: 'last_date_click' },
            'Click back to theater': { page: '/date', start: 'page_load_time', end: 'back_click' },
            'Click next to show': { page: '/date', start: 'last_date_click', end: 'next_click' },
            'View four times and select one': { page: '/show', start: 'page_load_time', end: 'last_show_click' },
            'Click back to date': { page: '/show', start: 'page_load_time', end: 'back_click' },
            'Click next to seat selection': { page: '/show', start: 'last_show_click', end: 'next_click' },
            'View and decide to select a seat': { page: '/seat', start: 'page_load_time', end: 'last_seat_click' },
            'Click back to show': { page: '/seat', start: 'page_load_time', end: 'back_click' },
            'Click next to summary': { page: '/seat', start: 'last_seat_click', end: 'next_click' },
            'View summary and decide to buy': { page: '/summary', start: 'page_load_time', end: 'visit_end_time' }
        };

        // ===========================================
        // V2 CONFIGURATION (Simplified flow)
        // ===========================================
        const V2_ACTION_COLORS = {
            'View six movies and select one ': '#8B5CF6',
            'Click next to date page': '#10B981',
            'View six options and select one': '#F59E0B',
            'Click next to summary': '#EF4444',
            'View summary and decide to buy': '#6366F1',
            // Special /options page actions
            'View six dates and select one': '#FF6B6B',
            'View four time slots and select one': '#4ECDC4',
            'View four radius and do not select one': '#45B7D1',
            'View nine seat areas and select one': '#96CEB4',
            'Click next to options': '#FCEA2B'
        };

        const V2_ACTION_CONFIG = {
            'View six movies and select one ': { page: '/v2', start: 'page_load_time', end: 'last_movie_click' },
            'Click next to date page': { page: '/v2', start: 'last_movie_click', end: 'next_click' },
            'View six options and select one': { page: '/filtered_options', start: 'page_load_time', end: 'last_option_click' },
            'Click next to summary': { page: '/filtered_options', start: 'last_option_click', end: 'next_click' },
            'View summary and decide to buy': { page: '/summary', start: 'page_load_time', end: 'visit_end_time' }
        };

        // ===========================================
        // HELPER FUNCTIONS
        // ===========================================
        function getCurrentActionColors() {
            const isV2Mode = document.getElementById('modeSwitch').checked;
            return isV2Mode ? V2_ACTION_COLORS : V1_ACTION_COLORS;
        }

        function getCurrentActionConfig() {
            const isV2Mode = document.getElementById('modeSwitch').checked;
            return isV2Mode ? V2_ACTION_CONFIG : V1_ACTION_CONFIG;
        }

        function parseTime(timestamp) {
            if (typeof timestamp === 'string') {
                return new Date(timestamp).getTime();
            }
            return new Date(timestamp).getTime();
        }

        // ===========================================
        // V1 PROCESSING FUNCTION
        // ===========================================
        function calculateV1ActionTimes(sessionData) {
            const actions = [];
            const pageTransitions = [];
            let sessionStart = Infinity;
            let sessionEnd = 0;

            const hasV1Page = sessionData.pages.some(page => page.page.startsWith('/v1'));
            if (!hasV1Page) {
                throw new Error('This session does not contain /v1 pages.');
            }

            for (const page of sessionData.pages) {
                const state = {};
                state.current_page = page.page.split('?')[0];
                state.page_load_time = parseTime(page.visitStartTime) + page.pageTransitionDuration;
                state.visit_end_time = parseTime(page.visitEndTime);

                sessionStart = Math.min(sessionStart, state.page_load_time);
                sessionEnd = Math.max(sessionEnd, state.visit_end_time);

                pageTransitions.push({
                    page: state.current_page,
                    time: state.page_load_time
                });

                // V1 specific click parsing
                for (const click of page.clicks.sort((a, b) => a.time - b.time)) {
                    const clickTime = parseTime(click.time);
                    const trackId = click.trackId ? click.trackId.toLowerCase() : null;

                    if (click.element == 'LI') {
                        state.last_distance_click = clickTime;
                        continue;
                    }

                    if (!trackId) continue;

                    const [thing, value] = trackId.split('=');
                    const cleanValue = value ? value.replace(/"/g, '') : '';

                    if (thing === 'button') {
                        if (cleanValue === 'next') {
                            state.next_click = clickTime;
                        } else if (cleanValue === 'back') {
                            state.back_click = clickTime;
                        }
                    } else if (thing === 'movie-card') {
                        state.last_movie_click = clickTime;
                    } else if (thing === 'schedule') {
                        state.last_date_click = clickTime;
                    } else if (thing === 'theatre-card') {
                        state.last_theatre_click = clickTime;
                    } else if (thing === 'show-time') {
                        state.last_show_click = clickTime;
                    } else if (thing == 'seat') {
                        state.last_seat_click = clickTime;
                    }
                }

                if (!state.last_distance_click) {
                    state.last_distance_click = state.page_load_time;
                }

                // Process V1 actions
                for (const [actionName, config] of Object.entries(V1_ACTION_CONFIG)) {
                    if (config.page !== state.current_page) continue;

                    const startTime = state[config.start];
                    const endTime = state[config.end];

                    if (!startTime || !endTime || endTime <= startTime) continue;

                    actions.push({
                        name: actionName,
                        startTime: startTime,
                        endTime: endTime,
                        duration: endTime - startTime,
                        page: config.page
                    });
                }
            }

            return {
                actions: actions.sort((a, b) => a.startTime - b.startTime),
                pageTransitions: pageTransitions.sort((a, b) => a.time - b.time),
                sessionStart,
                sessionEnd,
                sessionDuration: sessionEnd - sessionStart
            };
        }

        // ===========================================
        // V2 SPECIAL CASE HANDLER FOR /options PAGE
        // ===========================================
        function handleV2OptionsPage(page) {
            if (page.page.split('?')[0] !== '/options') {
                return [];
            }

            const actions = [];
            const state = {};
            state.current_page = page.page.split('?')[0];
            state.page_load_time = parseTime(page.visitStartTime) + page.pageTransitionDuration;
            state.visit_end_time = parseTime(page.visitEndTime);

            const clicks = page.clicks.filter(click => click.trackId).sort((a, b) => a.time - b.time);

            if (clicks.length > 0) {
                let previousClickTime = state.page_load_time;

                clicks.forEach(click => {
                    const trackId = click.trackId.toLowerCase();
                    const clickTime = parseTime(click.time);

                    if (trackId.includes('date')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'View six dates and select one',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    } else if (trackId.includes('timespan')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'View four time slots and select one',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    } else if (trackId.includes('distance')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'View four radius and do not select one',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    } else if (trackId.includes('seat-area')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'View nine seat areas and select one',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    } else if (trackId.includes('button="next"')) {
                        const duration = clickTime - previousClickTime;
                        if (duration > 0) {
                            actions.push({
                                name: 'Click next to options',
                                startTime: previousClickTime,
                                endTime: clickTime,
                                duration: duration,
                                page: '/options'
                            });
                        }
                    }

                    previousClickTime = clickTime;
                });
            }

            return actions;
        }

        // ===========================================
        // V2 PROCESSING FUNCTION
        // ===========================================
        function calculateV2ActionTimes(sessionData) {
            const actions = [];
            const pageTransitions = [];
            let sessionStart = Infinity;
            let sessionEnd = 0;

            const hasV2Page = sessionData.pages.some(page => page.page.startsWith('/v2'));
            if (!hasV2Page) {
                throw new Error('This session does not contain /v2 pages.');
            }

            for (const page of sessionData.pages) {
                const state = {};
                state.current_page = page.page.split('?')[0];
                state.page_load_time = parseTime(page.visitStartTime) + page.pageTransitionDuration;
                state.visit_end_time = parseTime(page.visitEndTime);

                sessionStart = Math.min(sessionStart, state.page_load_time);
                sessionEnd = Math.max(sessionEnd, state.visit_end_time);

                pageTransitions.push({
                    page: state.current_page,
                    time: state.page_load_time
                });

                // Check for special case handling for /options page
                const specialCaseActions = handleV2OptionsPage(page);
                if (specialCaseActions.length > 0) {
                    actions.push(...specialCaseActions);
                    continue;
                }

                // Normal V2 processing for other pages
                // V2 specific click parsing - follows the original V2 logic
                for (const click of page.clicks.sort((a, b) => a.time - b.time)) {
                    const clickTime = parseTime(click.time);
                    const trackId = click.trackId ? click.trackId.toLowerCase() : null;

                    if (!trackId) continue;

                    // V2 uses both patterns: thing=value AND includes
                    const [thing, value] = trackId.split('=');
                    const cleanValue = value ? value.replace(/"/g, '') : '';

                    if (thing === 'button') {
                        if (cleanValue === 'next') {
                            state.next_click = clickTime;
                        } else if (cleanValue === 'back') {
                            state.back_click = clickTime;
                        }
                    } else if (thing === 'movie-card') {
                        state.last_movie_click = clickTime;
                    } else if (thing === 'selected-option') {
                        state.last_option_click = clickTime;
                    }
                }

                // Process V2 actions
                for (const [actionName, config] of Object.entries(V2_ACTION_CONFIG)) {
                    if (config.page !== state.current_page) continue;

                    const startTime = state[config.start];
                    const endTime = state[config.end];

                    if (!startTime || !endTime || endTime <= startTime) continue;

                    actions.push({
                        name: actionName,
                        startTime: startTime,
                        endTime: endTime,
                        duration: endTime - startTime,
                        page: config.page
                    });
                }
            }

            return {
                actions: actions.sort((a, b) => a.startTime - b.startTime),
                pageTransitions: pageTransitions.sort((a, b) => a.time - b.time),
                sessionStart,
                sessionEnd,
                sessionDuration: sessionEnd - sessionStart
            };
        }

        // ===========================================
        // MAIN PROCESSING FUNCTION (Router)
        // ===========================================
        function calculateActionTimesForVisualization(sessionData) {
            const isV2Mode = document.getElementById('modeSwitch').checked;
            return isV2Mode ? calculateV2ActionTimes(sessionData) : calculateV1ActionTimes(sessionData);
        }

        function detectSessionType(sessionData) {
            const hasV1Page = sessionData.pages.some(page => page.page.startsWith('/v1'));
            const hasV2Page = sessionData.pages.some(page => page.page.startsWith('/v2'));

            if (hasV2Page) return 'v2';
            if (hasV1Page) return 'v1';
            return null;
        }

        // ===========================================
        // UI FUNCTIONS
        // ===========================================
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            document.getElementById('timelineSection').style.display = 'none';
        }

        function hideError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function toggleLegend() {
            const content = document.getElementById('legendContent');
            const toggle = document.getElementById('legendToggle');

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                toggle.textContent = '[+]';
            } else {
                content.classList.add('open');
                toggle.textContent = '[-]';
            }
        }

        function updateLegend() {
            const legendContent = document.getElementById('legendContent');
            const colors = getCurrentActionColors();

            legendContent.innerHTML = '';

            Object.entries(colors).forEach(([action, color]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${color}"></div>
                    <div class="legend-text">${action}</div>
                `;
                legendContent.appendChild(item);
            });
        }

        // ===========================================
        // VISUALIZATION FUNCTIONS
        // ===========================================
        function createVisualization(data) {
            const timelineDiv = d3.select('#timeline');
            timelineDiv.selectAll('*').remove();

            if (!tooltip) {
                tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('opacity', 0);
            }

            const margin = { top: 40, right: 50, bottom: 60, left: 100 };
            const height = 300;

            const sessionDuration = data.sessionEnd - data.sessionStart;
            const pixelsPerSecond = Math.max(0.5, sessionDuration / 1000 / 500); // Minimum 0.5px per second
            const width = Math.max(800, sessionDuration / 1000 * pixelsPerSecond);

            const svg = timelineDiv.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Create scales
            const xScale = d3.scaleLinear()
                .domain([data.sessionStart, data.sessionEnd])
                .range([0, width]);

            const yScale = d3.scaleBand()
                .domain(data.actions.map(d => d.name))
                .range([0, height - margin.bottom])
                .padding(0.1);

            // Add X axis
            g.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale)
                    .tickFormat(d => {
                        const seconds = Math.round((d - data.sessionStart) / 1000);
                        return `${seconds}s`;
                    }));

            // Add Y axis
            g.append('g')
                .call(d3.axisLeft(yScale));

            // Add session background
            g.append('rect')
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', width)
                .attr('height', height - margin.bottom)
                .attr('fill', '#f8f9fa')
                .attr('stroke', '#dee2e6')
                .attr('opacity', 0.3);

            // Group page transitions by temporal continuity
            const pageGroups = [];
            let currentGroup = null;
            const timeThreshold = 1000; // 1 second

            data.pageTransitions.forEach(transition => {
                if (!currentGroup ||
                    transition.time - currentGroup.endTime > timeThreshold ||
                    transition.page !== currentGroup.page) {
                    currentGroup = {
                        page: transition.page,
                        startTime: transition.time,
                        endTime: transition.time
                    };
                    pageGroups.push(currentGroup);
                } else {
                    currentGroup.endTime = transition.time;
                }
            });

            // Add page transition lines
            pageGroups.forEach(group => {
                const x = xScale(group.startTime);

                g.append('line')
                    .attr('class', 'page-transition')
                    .attr('x1', x)
                    .attr('y1', 0)
                    .attr('x2', x)
                    .attr('y2', height - margin.bottom)
                    .style('pointer-events', 'all')
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event) {
                        const startSeconds = Math.round((group.startTime - data.sessionStart) / 1000);
                        tooltip.transition()
                            .duration(200)
                            .style('opacity', .9);
                        tooltip.html(`
                            <strong>Page:</strong> ${group.page}<br>
                            <strong>Time:</strong> ${startSeconds}s<br>
                            <strong>Timestamp:</strong> ${new Date(group.startTime).toLocaleTimeString()}
                        `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function() {
                        tooltip.transition()
                            .duration(500)
                            .style('opacity', 0);
                    });
            });

            // Add action rectangles
            const colors = getCurrentActionColors();

            g.selectAll('.action-rect')
                .data(data.actions)
                .enter()
                .append('rect')
                .attr('class', 'action-rect')
                .attr('x', d => xScale(d.startTime))
                .attr('y', d => yScale(d.name))
                .attr('width', d => Math.max(2, xScale(d.endTime) - xScale(d.startTime)))
                .attr('height', yScale.bandwidth())
                .attr('fill', d => colors[d.name] || '#999')
                .attr('stroke', '#fff')
                .attr('stroke-width', 1)
                .on('mouseover', function(event, d) {
                    const startSeconds = Math.round((d.startTime - data.sessionStart) / 1000);
                    const endSeconds = Math.round((d.endTime - data.sessionStart) / 1000);
                    const durationSeconds = Math.round(d.duration / 1000);

                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    tooltip.html(`
                        <strong>Action:</strong> ${d.name}<br>
                        <strong>Page:</strong> ${d.page}<br>
                        <strong>Duration:</strong> ${durationSeconds}s<br>
                        <strong>Start:</strong> ${startSeconds}s<br>
                        <strong>End:</strong> ${endSeconds}s
                    `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.transition()
                        .duration(500)
                        .style('opacity', 0);
                });

            // Add timeline title with session info
            const totalSeconds = Math.round(data.sessionDuration / 1000);
            document.getElementById('timelineTitle').textContent =
                `Session Timeline - Duration: ${totalSeconds}s (${data.actions.length} actions)`;
        }

        // ===========================================
        // EVENT HANDLERS
        // ===========================================
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            hideError();

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    currentSessionData = JSON.parse(e.target.result);

                    // Auto-detect session type and update switch
                    const sessionType = detectSessionType(currentSessionData);
                    if (sessionType) {
                        document.getElementById('modeSwitch').checked = sessionType === 'v2';
                    }

                    processAndVisualize();
                } catch (error) {
                    showError('Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('modeSwitch').addEventListener('change', function() {
            if (currentSessionData) {
                processAndVisualize();
            }
        });

        function processAndVisualize() {
            if (!currentSessionData) return;

            try {
                const data = calculateActionTimesForVisualization(currentSessionData);
                updateLegend();
                createVisualization(data);
                document.getElementById('timelineSection').style.display = 'block';
            } catch (error) {
                showError(error.message);
            }
        }

        // Initialize legend as closed
        updateLegend();
    </script>
</body>
</html>